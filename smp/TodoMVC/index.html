<!doctype html>
<html lang="en" data-framework="bindingjs">
  <head>
    <meta charset="utf-8">
    <title>BindingJS - TodoMVC</title>
    <link rel="stylesheet" href="common/base.css">
    <script src="../../tst/res/jquery-2.1.1.min.js"></script>
    <script src="../../bld/stage3/src/core/binding.js"></script>
    <script src="../../bld/stage3/src/plugin/binding.adapter.model.json.js"></script>
    <script src="../../bld/stage3/src/plugin/binding.adapter.view.text.js"></script>
    <script src="../../bld/stage3/src/plugin/binding.adapter.view.value.js"></script>
    <script src="../../bld/stage3/src/plugin/binding.adapter.view.attr.js"></script>
    <script type="text/binding">
      @binding TodoMVC {
        #new-todo {
            value <- $newTodoText
            value -> $newTodoText
            // Use @newTodoText instead of $newTodoText
            // on:keydown("enter") +> $todos -> push({ completed: false, title: $newTodoText }) -> $todos
        }
        #todo-list li (@todo, @index: $todos) {
          #socket::todoSocket
          .view>input {
            @todoCompleted <- addCompletedToPath <- @todo
            attr:checked <- @todoCompleted
            // on:click +> attr:checked <-> @todo.completed
          }
          .view button {
            // Destroy
            // on:click +> $todos -> destroy(@index) -> $todos
          }
          @todoTitle <- addTitleToPath <- @todo
          .view label {
            text <- @todoTitle
          }
          // @tempTitle <~ ""
          .edit {
            value <- @todoTitle
            value -> @todoTitle
            // Instead:
            // value <-> @tempTitle
          }
          // @editing <~ false
          // attr:editing <- @editing
          label {
            // on:dblclick +> true -> @editing
          }
          .edit {
            // on:blur, on:keydown("esc") +> false -> @editing
            // on:blur +> @tempTitle -> @todoTitle
          }
        }
        
        #footer {
          @completed <- countCompleted <- $todos
          #todo-count {
            strong {
              text <- $getRemaining
            }
            span {
              text <- $getTodoString
            }
          }
          @completedsPresent <- gtZero <- @completed
          #clear-completed (@completedsPresent) {
            span {
              text <- @completed
            }
          }
        }
        
        /*
            Filters:
            @filterText <~ "all"
            @todosShown <- filter(@filterText == "all" ? {} : {completed: @filterText == "completed"}) <- $todos
            a.all {
                on:click +> "all" -> @filterText
                class:bold <- @filterText == "all"
            }
            a.active {
                on:click +> "active" -> @filterText
                class:bold <- @filterText == "active"
            }
            a.completed {
                on:click +> "completed" -> @filterText
                class:bold <- @filterText == "completed"
            }
        */
      }
    </script>
    <script type="text/javascript">
    var model = {
        // completed: boolean, title: string
        todos: [],
        newTodoText : "",
        getTodoString : function() {
            return model.todos.length == 1 ? "item" : "items"
        },
        getRemaining : function() {
            var count = 0
            for (var i = 0; i < model.todos.length; i++) {
                var todo = model.todos[i]
                if (todo.completed) {
                    count++
                }
            }
            return count
        }
    }
      
    $(function() {
        // Connectors, most of them can be removed as soon as expressions are available
        BindingJS.plugin("addCompletedToPath", function($api, _api) {
            return {
                process: function(input) {
                    if (!_api.util.isReference(input)) {
                        return input.completed
                    } else {
                        return input.cloneAndAddToPath("completed")
                    }
                }
            }
        })
        BindingJS.plugin("addTitleToPath", function($api, _api) {
            return {
                process: function(input) {
                    if (!_api.util.isReference(input)) {
                        return input.title
                    } else {
                        return input.cloneAndAddToPath("title")
                    }
                }
            }
        })
        BindingJS.plugin("countCompleted", function($api, _api) {
            return {
                process: function(input) {
                    var count = 0
                    for (var i = 0; i < input.length; i++) {
                        var item = input[i]
                        item = _api.util.convertIfReference(item)
                        if (item.completed) {
                          count++
                        }
                    }
                    return parseInt(input) + 1
                }
            }
        })
        BindingJS.plugin("gtZero", function($api, _api) {
            return {
                process: function(input) {
                    input = _api.util.convertIfReference(input)
                    return input > 0
                }
            }
        })

        var binding = BindingJS
            .create()
            .template("#todoapp")
            .binding($("script[type='text/binding']"))
            .model(model)
          
        binding.slot("TodoMVC.todoSocket").onInsert(function (keys, element) {
            var li = element.parent()
            var index = keys[0]
            var value = model.todos[index]
            li.find(".destroy").on("click", function() {
                for (var i = 0; i < model.todos.length; i++) {
                  if (model.todos[i] === value) {
                      model.todos.splice(i, 1)
                      break
                  }
                }
            })
            var label = li.find("label")
            var edit = li.find(".edit")
            label.on("dblclick", function() {
                li.addClass('editing')
                edit.focus()
            })
            edit.on("blur", function() {
                li.removeClass('editing')
            })
            var toggle = li.find(".toggle")
            toggle.change(function() {
                value.completed = toggle.prop("checked")
                model.todos.notify
            })
          
            element.detach()
        })

        binding
            .mount("#todoapp")
            .activate()
              
        $("#new-todo").keyup(function(e) {
            if (e.keyCode == 13) {
                model.todos.push({ completed: false, title: model.newTodoText })
                model.newTodoText = ""
            }
        })
    })

    // Required for Selenium Test only
    function pushQux() {
        model.todos.push({ completed: false, title: "qux" })
    }
    </script>
  </head>
  <body>
    <section id="todoapp">
      <header id="header">
        <h1>todos</h1>
        <input id="new-todo" placeholder="What needs to be done?" autofocus>
      </header>
      <section id="main">
        <input id="toggle-all" type="checkbox">
        <label for="toggle-all">Mark all as complete</label>
        <ul id="todo-list">
          <li>
            <div id="socket"></div>
            <div class="view">
              <input class="toggle" type="checkbox">
              <label></label>
              <button class="destroy"></button>
            </div>
            <input class="edit">
          </li>
        </ul>
      </section>
      <footer id="footer">
        <!-- span id="todo-count"><strong></strong> <span></span> left</span>
          <ul id="filters">
            <li>
              <a class="selected" href="#/">All</a>
            </li>
            <li>
              <a href="#/active">Active</a>
            </li>
            <li>
              <a href="#/completed">Completed</a>
            </li>
          </ul>
          <button id="clear-completed">Clear completed (<span></span>)</button -->
      </footer>
    </section>
    <footer id="info">
      <p>Double-click to edit a todo</p>
      <p>Written by <a href="https://github.com/rummelj">Johannes Rummel</a></p>
      <!-- p>Part of <a href="http://todomvc.com">TodoMVC</a></p -->
    </footer>
  </body>
</html>