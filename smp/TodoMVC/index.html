<!doctype html>
<!-- Todo
    - The edit should be saved on both blur and enter, and the editing class should be removed. Make sure to .trim() the input and then check that it's not empty. !!!If it's empty the todo should instead be destroyed. If escape is pressed during the edit, the edit state should be left and any changes be discarded.!!!
    
    - Clear completed and toggle all does not show on reload because todo is not changed so the initiator does not fire
    
    - Routing
-->
<html lang="en" data-framework="bindingjs">
  <head>
    <meta charset="utf-8">
    <title>BindingJS - TodoMVC</title>
    <link rel="stylesheet" href="common/base.css">
    <script src="../../tst/res/jquery-2.1.1.min.js"></script>
    <script src="../../bld/stage3/src/core/binding.js"></script>
    <script src="../../bld/stage3/src/plugin/binding.adapter.model.json.js"></script>
    <script type="text/binding">
      @binding TodoMVC {
        
        // Add new item on enter and reset input field
        #new-todo {
            // Trim value
            @newTitle <- trim <- value
            // Only add if non-empty
            on:keydown("enter") +> 
                @newTitle === "" ? 
                    $todos :
                    $todos + { completed: false, title: @newTitle }
                        -> $todos
            // Whenever todos changes, store them
            $todos -> $storeTodos
            // Reset to empty string
            on:keyup("enter") +> "" -> value
        }
            
        // When there are no todos, #main and #footer should be hidden.
        #main, #footer ($todos.length > 0) {
            // Iterate list of todos
            #todo-list li (@todo, @index: $todos) {
                @completed <- @todo.completed
                @title <- @todo.title
                class:completed <- @completed
                // Indicator if in editing mode
                @editing <~ false
                class:editing <- @editing
                
                // Display title
                .view label {
                    text <- @title
                    // Switch into editing mode if doubleclicked
                    on:dblclick +> true -> @editing
                }
                // Mark todo as completed
                .view input {
                    on:click +> attr:checked <-> @completed
                    // If toggleAll changes it also updates the single todo
                    @toggleAllByUser +> @toggleAll === undefined ? @completed : @toggleAll -> @completed
                }
                // Delete todo
                .view button {
                    on:click +> $todos - $todos[@index] -> $todos
                }
                
                // Allow temporary editing
                // Adding the empty string is necessary to prevent storing
                // A Reference
                @tempTitle <~ @title + ""
                .edit {
                    // Focus if @editing becomes true
                    @editing -> on:focus
                    // Write value to temporary title
                    value <-> @tempTitle
                    // Just leave editing mode if blur, esc or enter occurs
                    on:blur, on:keydown("esc", "enter") +> false -> @editing
                    // Reset tempTitle on leaving edit mode
                    //on:blur, on:keydown("esc", "enter") +> @title -> @tempTitle
                    // Write actual title back if blur or enter occurs
                    on:blur, on:keydown("enter") +> @tempTitle -> trim -> @title
                }
            }
            
            // Toggle all if the completeds count equals the number of todos
            // Do this evaluation only if the list of todos changes
            @toggleAll <- $countCompleted === $todos.length <+ $todos
            @toggleAllByUser <~ undefined
            #toggle-all {
                // toggleAll represents the computed value of the toggle
                // which is not necessarily set by the user
                @toggleAll <-> attr:checked <+ on:click
                // if the user actively clicks toggleAllByUser is used
                // to notify the todo items
                on:click -> @toggleAllByUser
            }
        }
        
        #footer {
          @completed <- $countCompleted <+ $todos
          @incompleted <- $todos.length - @completed
          #todo-count {
            strong {
              // Display number of incomplete
              text <- @incompleted
            }
            span {
              // Show correct string
              text <- @incompleted === 0 || @incompleted > 1 ? "items" : "item"
            }
          }
          // Show only if number of completeds is not zero
          #clear-completed (@completed > 0) {
            span {
              text <- @completed
            }
            on:click +> $todos -> clearCompleted -> $todos
          }
        }
        
        /*
            Filters:
            @filterText <~ "all"
            @todosShown <- filter(@filterText == "all" ? {} : {completed: @filterText == "completed"}) <- $todos
            a.all {
                on:click +> "all" -> @filterText
                class:bold <- @filterText == "all"
            }
            a.active {
                on:click +> "active" -> @filterText
                class:bold <- @filterText == "active"
            }
            a.completed {
                on:click +> "completed" -> @filterText
                class:bold <- @filterText == "completed"
            }
        */
      }
    </script>
    <script type="text/javascript">
    var model = {
        // completed: boolean, title: string
        todos: (function() {
            if (typeof(Storage) !== "undefined" && localStorage.getItem("todos-bindingjs")) {
                return JSON.parse(localStorage.getItem("todos-bindingjs"))
            } else {
                return []
            }
        })(),
        countCompleted: function() {
            var count = 0
            for (var i = 0; i < model.todos.length; i++) {
                count += model.todos[i].completed ? 1 : 0
            }
            return count
        },
        storeTodos: function() {
            if (typeof(Storage) !== "undefined") {
                localStorage.setItem("todos-bindingjs", JSON.stringify(model.todos))
            }
        }
    }
    
    var binding
    $(function() {
        // Connectors, most of them can be removed as soon as expressions are available
        BindingJS.plugin("trim", function($api, _api) {
            return {
                process: function(string) {
                    string = _api.util.convertIfReference(string)
                    return string.trim()
                }
            }
        })
        BindingJS.plugin("clearCompleted", function($api, _api) {
            return {
                process: function(todos) {
                    _api.util.array.removeIf(todos, function (todo) {
                        return _api.util.convertToValues(todo).completed
                    })
                    return todos
                }
            }
        })

        binding = BindingJS
            .create()
            .template("#todoapp")
            .binding($("script[type='text/binding']"))
            .model(model)
            .mount("#todoapp")
            .activate()
    })

    // Required for Selenium Test only
    function pushQux() {
        model.todos.push({ completed: false, title: "qux" })
    }
    </script>
  </head>
  <body>
    <section id="todoapp">
      <header id="header">
        <h1>todos</h1>
        <input id="new-todo" placeholder="What needs to be done?" autofocus>
      </header>
      <section id="main">
        <input id="toggle-all" type="checkbox">
        <label for="toggle-all">Mark all as complete</label>
        <ul id="todo-list">
          <li>
            <div id="socket"></div>
            <div class="view">
              <input class="toggle" type="checkbox">
              <label></label>
              <button class="destroy"></button>
            </div>
            <input class="edit">
          </li>
        </ul>
      </section>
      <footer id="footer">
        <span id="todo-count"><strong></strong> <span></span> left</span>
          <ul id="filters">
            <li>
              <a class="selected" href="#/">All</a>
            </li>
            <li>
              <a href="#/active">Active</a>
            </li>
            <li>
              <a href="#/completed">Completed</a>
            </li>
          </ul>
          <button id="clear-completed">Clear completed (<span></span>)</button>
      </footer>
    </section>
    <footer id="info">
      <p>Double-click to edit a todo</p>
      <p>Written by <a href="https://github.com/rummelj">Johannes Rummel</a></p>
      <!-- p>Part of <a href="http://todomvc.com">TodoMVC</a></p -->
    </footer>
  </body>
</html>